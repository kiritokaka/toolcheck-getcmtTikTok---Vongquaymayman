<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VÃ²ng quay may máº¯n ğŸ€</title>
<style>
  :root{
    --ink:#e5e7eb; --muted:#93a3b5; --line:#1f2a44; --bg:#0b1220;
    --primary:#2563eb; --danger:#ef4444;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body{
    margin:0;color:var(--ink);
    background:
      radial-gradient(1200px 800px at -10% 0%, #0ea5e9 0%, transparent 40%),
      radial-gradient(1200px 800px at 110% 100%, #a78bfa 0%, transparent 40%),
      linear-gradient(180deg, #0b1220 0%, #0b1220 100%);
    min-height:100vh;
  }
  .wrap{max-width:1200px;margin:0 auto;padding:20px;display:grid;gap:20px;grid-template-columns:1fr; position:relative; z-index:1;}
  @media(min-width:980px){.wrap{grid-template-columns:1fr 1fr}}
  h1{margin:0 0 8px;font-size:26px}
  p{margin:0 0 12px;color:#cbd5e1;font-size:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type="number"],input[type="text"]{
    width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.04);color:#e5e7eb
  }
  input::placeholder{color:#64748b}
  .btn{
    appearance:none;border:0;border-radius:14px;padding:12px 18px;cursor:pointer;font-weight:700;color:white;
    background:linear-gradient(135deg,var(--primary),#9333ea); box-shadow:0 8px 24px rgba(37,99,235,.35);
    transition:transform .15s ease;
  }
  .btn:hover{transform:translateY(-1px)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-ghost{background:linear-gradient(135deg,#334155,#111827)}
  .card{border:1px solid var(--line);border-radius:16px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02))}
  .muted{color:#93a3b5;font-size:13px}
  .wheelwrap{display:grid;place-items:center}
  .wheel-shell{position:relative;display:grid;place-items:center}
  .topnote{position:absolute;top:-34px;left:50%;transform:translateX(-50%);font-size:12px;color:#9aa9bf}
  .pointer{position:absolute;z-index:2;top:-6px;left:50%;transform:translateX(-50%);
    width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-top:36px solid var(--danger);
    filter:drop-shadow(0 4px 12px rgba(239,68,68,.35))}
  canvas{position:relative;z-index:1;filter:drop-shadow(0 20px 40px rgba(2,6,23,.5));border-radius:20px;background:linear-gradient(180deg,#0f172a,#111827)}
  .result-item{margin-top:10px}.result-name{font-weight:800}.result-info{display:block;color:#34d399;font-size:13px}
  textarea.preview{width:100%;height:220px;padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);color:#e5e7eb}
  .overlay{position:fixed;inset:0;display:none;place-items:center;z-index:60;background:rgba(2,6,23,.55);backdrop-filter:blur(6px)}
  .modal{width:min(92vw,640px);border-radius:18px;padding:28px;background:linear-gradient(180deg,#0b1220,#0f172a);border:1px solid var(--line);text-align:center}
  .modal h2{margin:0 0 10px;font-size:28px}.modal .name{font-size:22px;font-weight:900}.modal .info{margin-top:10px;color:#a7f3d0}
  /* Confetti canvas: sau & áº©n máº·c Ä‘á»‹nh */
  #fx{position:fixed;inset:0;pointer-events:none;z-index:0;background:transparent!important;display:none;}
  /* Spinner */
  .loading{display:none;align-items:center;gap:8px;color:#93c5fd}
  .loading.show{display:flex}
  .spinner{width:16px;height:16px;border:2px solid #60a5fa;border-top-color:transparent;border-radius:50%;animation:spin 0.9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<canvas id="fx"></canvas>
<div class="wrap">
  <section>
    <h1>VÃ²ng quay may máº¯n ğŸ€</h1>
    <p>Nháº­p sá»‘ Ã´ cáº§n Ä‘iá»n "Link" Ä‘á»ƒ get data trÃªn Link(video, áº£nh) TikTok</p>

    <div class="row">
      <input id="numLinks" type="number" min="1" placeholder="Nháº­p sá»‘ Ã´ Ä‘iá»n link ( vd: 1,2,3â€¦ )" />
      <button class="btn" id="makeInputsBtn">Táº¡o Ã´ link</button>
      <button class="btn btn-ghost" id="resetBtn" style="display:none">Reset vÃ²ng</button>
    </div>

    <div id="linksBox" class="card" style="display:none;margin-top:10px">
      <div class="muted" style="margin-bottom:6px">DÃ¡n "Link" TikTok mÃ  báº¡n cáº§n get data vÃ o cÃ¡c Ã´ dÆ°á»›i:</div>
      <div id="linksContainer" class="row" style="flex-direction:column;align-items:stretch"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="createBtn">Táº¡o</button>
        <div id="createInfo" class="muted"></div>
      </div>
      <div id="loading" class="loading" style="margin-top:6px">
        <div class="spinner"></div>
        <div>Äang láº¥y dá»¯ liá»‡u tá»« cÃ¡c linkâ€¦</div>
      </div>
    </div>

    <div id="dataBox" class="card" style="display:none;margin-top:12px">
      <div><b>Xem nhanh data Ä‘Ã£ get trong "Link"</b>:</div>
      <textarea id="rawData" class="preview" readonly></textarea>
      <div class="muted">TÃ­nh nÄƒng 'Check': <b> ÄÃ£ tá»± Ä‘á»™ng lá»c cÃ¡c comment bá»‹ "trÃ¹ng nhau", "bá»‹ thiáº¿u 3 dáº¥u @ -> tag tÃªn 3 ngÆ°á»i", "bá»‹ thiáº¿u dÃ£y 4 sá»‘ Ä‘uÃ´i Ä‘t 'X-X-X-X'" á»Ÿ trong comment tá»•ng há»£p á»Ÿ cÃ¡c "Link" trÆ°á»›c khi tráº£ ra mÃ n hÃ¬nh </b>.</div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="spinBtn" disabled>Quay</button>
      <div id="stateInfo" class="muted">ChÆ°a cÃ³ dá»¯ liá»‡u.</div>
    </div>

    <div id="resultBox" class="card" style="display:none;margin-top:12px">
      <div><b>Káº¿t quáº£</b></div>
      <div id="results"></div>
    </div>
  </section>

  <section class="wheelwrap">
    <div class="wheel-shell">
      <div class="pointer" id="pointer"></div>
      <div class="topnote">MÅ©i tÃªn</div>
      <canvas id="wheel" width="760" height="760" style="width:660px;height:660px"></canvas>
    </div>
  </section>
</div>

<script id="EMBED_DATA" type="text/plain">
Winh_169ğŸ§ 1208 @Nguyen Hoang Bii @AhTuan @lhatemyself

yengg.0214 @SÄƒn Ä‘Æ°á»£c phÃº bÃ  thÃ¬ Ä‘á»•i tÃªn ğŸ˜‡ @longma2104 @Nháº­t

puppiedayyy. 4738 @ë°©ë¦° @ğŸ° @ğŸ’

FzVac 5968 @Giang Linh @ahnq @TunLeo

Nguyá»…n Vinh 3636@Thiáº¿u Gia Háº£i PhÃ²ng ğŸ¥Š @NgoÃ¡cğŸ˜­ @CÃ´ng Chá»© HoÃ ng

nt 4650 @trung kien @phthaoo @ğ“Ÿğ“±ğ“¾Ì›ğ“¸Ì›ğ“·ğ“° ğ“›ğ“²ğ“·ğ“±ğŸŒ·

No^.^Name 2511 ğŸ—¿sn mÃ¬nh vÃ  8th8 lÃ  nga6f mÃ¬nh Ä‘i Ä‘áº¥uğŸ—¿@ãƒŸÂ°ï¼°ï½ˆÃºï½ƒÂ°å½¡ @HoÃ ng Anh @Kudo(å¤©å‘)

Thá»ƒ Thao Quang Huy 6508 @BÃ¹i.Tuáº¥n @Thuuâ€‚Háº±ngggâ€‚ÄÃ¢yyyyâ€‚ğŸ™ˆğŸ™ˆ @QuangHieu25Shop

pttt 8015@Dqh @Quantaison @xuan Khanh

Máº·c Äá»“ Hot Trend 6508 @BÃ¡nh máº­t ğŸª @MÃ¬ Cáº§u LÃ´ng @ManhHuu Dropshipping

ahnq 3653 @VÆ°Æ¡ng Tiáº¿n570 @Trá»ng NhÃ¢n7805 @noir

Táº­p Ä‘Ã¡nh cáº§u .. 0017 @VÃ´ Ä‘á»‹ch thÃ¬ Ä‘á»•i tÃªn ğŸ¸ @A ğŸ‘ @MÃ©oğŸ˜¸

Quantaison 0364 @pttt @Tuan Kiet @é„§å¾·æ˜

@123 9344 @?! @Zitsau @Vitiudeyy

mÃª cáº§u lÃ´ng 9328@nÆ°á»›c suá»‘i @Bukami Badminton @láº¯m cute

Thiáº¿u Gia Háº£i PhÃ²ng ğŸ¥Š 9406 @aomacanada @Ngvinh @CÃ´ng Chá»© HoÃ ng

VÆ°Æ¡ng Tiáº¿n 5095 @Thiáº¿u Gia Háº£i PhÃ²ng ğŸ¥Š @Nguyá»…n Vinh @CÃ´ng Chá»© HoÃ ng

TÃº Ma 1104 @VÆ°Æ¡ng Tiáº¿n @@Má» HÆ¡i Há»—n @Tuyáº¿n Ma

iam cua 4394 @iwmqiwwb @ğŸ¥€ğ“’ğ“ªğ“¼ğ“¼ğ“®ğ”‚ğŸ‚ @ThÃ­ch Ãºn mÃ¡t cha lÃ¡t teeğŸµ

Nam Nguyen 3382 @zakangvo @Quantaison @Dqh

Giang Linh 5368 @MÃª thá»‹t gÃ  hehehe @dq @ğŸ˜ğŸ¤ŸğŸ»

Dqh @ltp3011 @qunhong101 @damduchao2008 5651

SÄƒn Ä‘Æ°á»£c phÃº bÃ  thÃ¬ Ä‘á»•i tÃªn ğŸ˜‡ 8269@yengg. @Nháº­t @ğ“›ğ“¸ğ“·ğ“° ğ“·ğ“°ğ“®ğ“»

hbacnef 7444 @ğŸŒŸHÃ  elliâœ¨nÃ¨ @THANG LONG VOLLEYBALL CLUB @VÃ¢n Nhi

vÅ© tháº£o 7880 @nanhhh_311 @Nguyá»…n Minh TÃ¢m @Anh

Phao130204? 6237@Lelinh207 @@Sinh tá»‘ bÆ¡ğŸ’¦ @@Xoiiu

Dat 4549 @Quay láº¡i tuá»•i thÆ¡ âœ¨ @PhÃ¡t @PhÃ¡t ğŸ¥°ğŸ¥°ğŸ¥°ğŸ¥°

MEOBEOSHOP 5216 nha shop. @VÆ°Æ¡ng Tiáº¿n @Tuann @Nam Anh Tráº§n

VÄƒn Báº£o 3520 @HoÃ ng tá»­ Máº¡nh @LuLu_m72 @Quá»³nh Pháº¡m

nobi 4948 @Minipolo @ç‰ç¢§ğŸ¸ğŸ“šğŸ’¸ @ÄÃ o PA

Arbalest 7645 @occho12333 @Nguyá»…n Thuá»³ Linh @cuuvuiveğŸ‘

TÃ¡o ğŸ˜ 5798 @Hiá»n Trá»‹nh @Minh Nguyá»‡t @dunglee.29

ngá»cc hann ğŸ 2160@kanh @É´Êœá´€Ì£Ì‚á´› á´ÉªÉ´ÊœğŸ’ @Thur Nhá» Con

toxinhğŸ‘» 1448 @LiÃªn VÅ© 1112 @LÃª Long @TranDuc mong trÃºng giáº£i cá»§a shop áº¡ ğŸ¥°

Minipolo 9415 @Arbalest @BÃ¡ Nha @Nguyá»…n Thuá»³ Linh

Ä‘am mÃª naÌ 8382@haha @mega @phatfreestyle

HÃ¹ng Pháº¡m @FANJJBA @Ph Vy @xe Ä‘áº¡p thá»§ng lá»‘p=/ 6833 :>

ğ™†ğ™Ã¡ğ™£ğ™ğ™‡ğ™ğ™£ğ™ 3642 @HoÃ i An @hya @Nguyá»…n PhÆ°Æ¡ng Vy

NgÆ°á»i xáº¥u Ä‘áº¹p trai 8159 mong há»¯u duyÃªn cÃ³ con vá»£t má»›i ğŸ™ğŸ™ @log.me20 @Äá»©c NghÄ©a @Pass DEA-C01 thÃ¬ Ä‘á»•i tÃªn

Tá»› lÃ  Banh ğŸ«¶ 3255@? @VÅ© Äá»©c Máº¡nh @LÃª Minh Trang ğŸ˜˜

Giá» mÃ y sao 8868@LÃª Há»¯u Minh Long @utnhotruong3 @Minh Long LÃª Há»¯u

Xao Xao 5641 @tinnn0.0.0 @vÅ© tháº£o @NgVNâ€‚gá»‘câ€‚Háº£iâ€‚PhÃ²ng

Anh giÃ¡o cá»£t nháº£ğŸ—£ï¸ 8574 @Thu VÃ¢n LÃª @Stay'wHÃ­uâœ”â™¥ @Abcabc

HoÃ ng tá»­ Máº¡nh 0340 @Longgg.1510 @Vht @Bim

manxanh 7233 @å…¬å¸(kiÃªn) ğŸŒš @hodungdeptrai102 @qd.3101

ChÃº Vá»‹t VÃ ng 5809@Longgg.1510 @HoÃ ng tá»­ Máº¡nh @SÆ¡n láº¡i cuá»™c Ä‘á»i

_hgd_ 5956 @Tá»‘ng ThÆ°Æ¡ng @iambong @daominhtuan

Nguyá»…n Thuá»³ Linh 3854 @MadHoag @Ngaaaâ€¢_â€¢ @Hoa Thá»‹ Má»¹ LÃª

ÄÄƒng Minh 1859 @LÃª Trang Nhung @LÆ°Æ¡ng ÄÄƒng46 @NgÃ´ HoÃ ng Long975

canhdtjp232 4037 @dat28873s5f @ronalgdfcvl @amnhasuklrv

haha 5376@máº¯m tÃ´m @Ä‘am mÃª naÌ @Phu Phu

Tá»› lÃ  áº®n Ä‘Ã¢yyyâ˜ƒï¸ 0335 @Tháº¿ Anh @CÃ¡ NÃ³c 38 cÃ¢n @Yáº¿u tiáº¿ng Trung

ronalgdfcvl 2073 @dat28873s5f @canhdtjp232 @haychlpn1ov

amnhasuklrv 6996 @dat28873s5f @ronalgdfcvl @haychlpn1ov

haychlpn1ov 7529 @dat28873s5f @amnhasuklrv @louiejaybaloc

dat28873s5f 9932 @amnhasuklrv @Dat @haychlpn1ov

ngÆ°á»i xáº¥u 2959 @Giang Nguyen @Thai Hoc Bui @Äá»— Tuáº¥n Äáº¡i

zgjxtskfsjt 3200@Jin_â„ï¸@nkhğŸ’ª @..

bÃ­ğŸ¦Š 3203@Äá»©c Nguyá»…n Min @CÃºc cu @Long máº¥t nick

HÆ°Æ¡ng Lan 3224 @Target 1 nÄƒm nháº£y trÄƒm bÃ iğŸ¤¡ @@ThÃ­c Ãºn matcha latte ğŸµ @Thanh ThÃºy Nguyá»…n Ãª vÃ o chÆ¡i nÃ y

Trung Nguyá»…n 0294 @Huyen Ngoc5605 @LouisNguyennn @LynnğŸ«¶ @hÆ¡i ngu 1 tÃ­
</script>

<!-- Overlay -->
<div id="overlay" class="overlay">
  <div class="modal">
    <h2>ğŸ‰ ChÃºc má»«ng ngÆ°á»i may máº¯n!</h2>
    <div class="name" id="ovName"></div>
    <div class="info" id="ovInfo"></div>
    <div style="height:12px"></div>
    <button class="btn" id="ovContinue">Tiáº¿p tá»¥c</button>
  </div>
</div>

<script>
/* ===== Cáº¤U HÃŒNH ===== */
const FORCED_NAME = "NgÆ°á»i xáº¥u Ä‘áº¹p trai";
const INNER_RATIO = 0.22, GAP_RATIO = 0.40, GAP_CAP = 0.08;
/* thá»i gian quay (nhanh vá»«a) */
const BASE_MS_MIN = 2000, BASE_MS_MAX = 2900;
const EXTRA_MS_MIN = 1800, EXTRA_MS_MAX = 3300;

/* ===== STATE ===== */
let items = []; let spins = 0; let rotation = 0;
let isSpinning = false; let overlayActive = false;

/* ===== DOM ===== */
const $numLinks = document.getElementById("numLinks");
const $makeInputsBtn = document.getElementById("makeInputsBtn");
const $linksBox = document.getElementById("linksBox");
const $linksContainer = document.getElementById("linksContainer");
const $createBtn = document.getElementById("createBtn");
const $createInfo = document.getElementById("createInfo");
const $dataBox = document.getElementById("dataBox");
const $rawData = document.getElementById("rawData");
const $spinBtn = document.getElementById("spinBtn");
const $resetBtn = document.getElementById("resetBtn");
const $stateInfo = document.getElementById("stateInfo");
const $resultBox = document.getElementById("resultBox");
const $results = document.getElementById("results");
const $canvas = document.getElementById("wheel");
const ctx = $canvas.getContext("2d");
const $overlay = document.getElementById("overlay");
const $ovName = document.getElementById("ovName");
const $ovInfo = document.getElementById("ovInfo");
const $fx = document.getElementById("fx");
const fx = $fx.getContext("2d");
const $pointer = document.getElementById("pointer");
const $loading = document.getElementById("loading");

const norm = s => String(s).normalize("NFKC").trim().toLowerCase();

/* ===== Fake Ã´ link ===== */
$makeInputsBtn.addEventListener("click", () => {
  const n = Math.max(1, parseInt($numLinks.value || "0", 10) || 0);
  $linksContainer.innerHTML = "";
  for (let i=0;i<n;i++){
    const inp=document.createElement("input");
    inp.type="text"; inp.placeholder="DÃ¡n link TikTok #"+(i+1);
    $linksContainer.appendChild(inp);
  }
  $linksBox.style.display=""; $createInfo.textContent="";
});

/* ===== Parser giá»¯ nguyÃªn thá»© tá»± ===== */
function parseEmbedded(raw){
  const lines = raw.replace(/\r/g,"").split("\n");
  const groups=[]; let buf=[];
  for(const line of lines){
    const s=line.trim();
    if(s===""){ if(buf.length){groups.push(buf); buf=[];} }
    else buf.push(s);
  }
  if(buf.length) groups.push(buf);

  const pairMode = groups.length===1 && groups[0].length>2;
  const out=[];
  if(pairMode){
    const flat=groups[0];
    for(let i=0;i<flat.length;i+=2) out.push({name:flat[i]||"", info:flat[i+1]||""});
  }else{
    for(const g of groups){
      if(g.length>=2) out.push({name:g[0], info:g.slice(1).join(" ")});
      else{ const full=g[0]; out.push({name:(full.split("@")[0].trim()||full), info:full}); }
    }
  }
  return out;
}

/* ===== Náº¡p data (fake delay + spinner) ===== */
$createBtn.addEventListener("click", ()=>{
  const raw=(document.getElementById("EMBED_DATA").textContent||"").trim();

  // UI: báº­t spinner, disable nÃºt
  $loading.classList.add("show");
  $createBtn.disabled = true;
  $createInfo.textContent = "Äang quÃ©t cÃ¡c linkâ€¦";

  // Delay ngáº«u nhiÃªn 1.2â€“2.2s Ä‘á»ƒ giá»‘ng fetch tháº­t
  const delay = Math.floor(1200 + Math.random()*1000);

  setTimeout(()=>{
    $rawData.value=raw;
    items=parseEmbedded(raw); // GIá»® THá»¨ Tá»°
    spins=0; rotation=0;

    drawWheel(); updateState();
    $dataBox.style.display="";
    $createInfo.textContent=`ÄÃ£ náº¡p ${items.length} má»¥c.`;
    $spinBtn.disabled = items.length===0;
    $resetBtn.style.display="inline-block";
    $results.innerHTML=""; $resultBox.style.display="none";
  }, delay);

  // Táº¯t spinner sau khi hiá»ƒn thá»‹ data xong (thÃªm 150ms cho mÆ°á»£t)
  setTimeout(()=>{
    $loading.classList.remove("show");
    $createBtn.disabled = false;
  }, delay + 150);
});

/* ===== Audio ===== */
let ac;
function acx(){ if(!ac) ac=new (window.AudioContext||window.webkitAudioContext)(); return ac; }
// Ä‘áº£m báº£o AudioContext active khi user click
async function ensureAudio(){ try{ const A=acx(); if(A.state!=="running") await A.resume(); }catch{} }

function playTick(){
  try{
    const A=acx(), o=A.createOscillator(), g=A.createGain();
    o.type="sine"; o.frequency.setValueAtTime(800,A.currentTime);
    o.frequency.exponentialRampToValueAtTime(600,A.currentTime+0.05);
    g.gain.setValueAtTime(0.0001,A.currentTime);
    g.gain.exponentialRampToValueAtTime(0.04,A.currentTime+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,A.currentTime+0.07);
    o.connect(g); g.connect(A.destination); o.start(); o.stop(A.currentTime+0.07);
  }catch{}
}

/* Fanfare chÃºc má»«ng (báº£n trÆ°á»›c) */
function playVictory(){
  try{
    const A = acx();
    const t0 = A.currentTime;
    const master = A.createGain();
    master.gain.setValueAtTime(0.9, t0);
    master.connect(A.destination);

    function note(freq, start, dur, vol=0.32, type="triangle"){
      const o1=A.createOscillator(), g1=A.createGain();
      const o2=A.createOscillator(), g2=A.createGain();
      o1.type=type; o2.type=type;
      o1.frequency.value=freq; o2.frequency.value=freq*2;
      g1.gain.setValueAtTime(0.0001, start);
      g1.gain.exponentialRampToValueAtTime(vol, start+0.02);
      g1.gain.exponentialRampToValueAtTime(0.0001, start+dur);
      g2.gain.setValueAtTime(0.0001, start);
      g2.gain.exponentialRampToValueAtTime(vol*0.18, start+0.02);
      g2.gain.exponentialRampToValueAtTime(0.0001, start+dur);
      o1.connect(g1); o2.connect(g2);
      g1.connect(master); g2.connect(master);
      o1.start(start); o2.start(start);
      o1.stop(start+dur+0.05); o2.stop(start+dur+0.05);
    }

    const C5=523.25, E5=659.25, G5=783.99, C6=1046.5;
    [C5,E5,G5].forEach((f,i)=> note(f, t0 + i*0.015, 0.85, 0.28, "triangle")); // há»£p Ã¢m má»Ÿ
    note(G5, t0 + 0.9, 0.55, 0.34, "sawtooth");                                 // Ä‘iá»ƒm rÆ¡i
    note(C6, t0 + 1.08, 0.75, 0.36, "sawtooth");
  }catch{}
}

/* ===== Váº½ bÃ¡nh xe: dÃ y + khe há»Ÿ ===== */
function drawWheel(){
  const dpr=window.devicePixelRatio||1, size=760;
  $canvas.width=size*dpr; $canvas.height=size*dpr;
  if(ctx.resetTransform) ctx.resetTransform(); ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,size,size);
  const cx=size/2, cy=size/2;
  const rOuter=size/2-16, rInner=rOuter*INNER_RATIO, rText=(rOuter+rInner)/2 - 2;

  ctx.save(); ctx.translate(cx,cy); ctx.rotate(rotation);
  const n=Math.max(1,items.length);
  const baseSeg=(2*Math.PI)/n, gap=Math.min(GAP_CAP, baseSeg*GAP_RATIO), seg=baseSeg-gap;

  for(let i=0;i<n;i++){
    const start=i*baseSeg + gap/2, end=start+seg;
    const grad=ctx.createRadialGradient(0,0,rInner, 0,0,rOuter);
    grad.addColorStop(0, i%2 ? "#1f2937" : "#0b1220");
    grad.addColorStop(1, i%2 ? "#334155" : "#1f2937");
    ctx.beginPath(); ctx.arc(0,0,rOuter,start,end); ctx.arc(0,0,rInner,end,start,true); ctx.closePath();
    ctx.fillStyle=grad; ctx.fill();

    // viá»n lÃ¡t
    ctx.beginPath(); ctx.arc(0,0,rOuter,start,start+0.001);
    ctx.lineWidth=2; ctx.strokeStyle="#23314f"; ctx.stroke();

    // chá»¯
    const label=items[i]?.name||""; const angle=start+seg/2;
    ctx.save(); ctx.rotate(angle);
    ctx.textAlign="right"; ctx.font="bold 18px system-ui,-apple-system,Segoe UI,Roboto"; ctx.fillStyle="#e5e7eb";
    wrapText(ctx,label,rText,0,210,21);
    ctx.restore();
  }

  // viá»n + hub
  ctx.beginPath(); ctx.arc(0,0,rOuter,0,2*Math.PI); ctx.lineWidth=5; ctx.strokeStyle="#4b5563"; ctx.stroke();
  ctx.beginPath(); ctx.arc(0,0,rInner,0,2*Math.PI); ctx.lineWidth=5; ctx.strokeStyle="#374151"; ctx.stroke();
  ctx.beginPath(); ctx.arc(0,0,rInner*0.72,0,2*Math.PI); ctx.fillStyle="#0f172a"; ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle="#334155"; ctx.stroke();
  ctx.restore();
}
function wrapText(ctx,text,x,y,maxWidth,lineHeight){
  const words=String(text).split(" "); let line="", yy=y;
  for(let n=0;n<words.length;n++){
    const test=line+words[n]+" ";
    if(ctx.measureText(test).width>maxWidth && n>0){ ctx.fillText(line,x,yy); line=words[n]+" "; yy+=lineHeight; }
    else line=test;
  }
  ctx.fillText(line,x,yy);
}

/* ===== Confetti ===== */
let confettiParticles=[];
function burstConfetti(x,y,count=140){
  const $fx = document.getElementById("fx");
  $fx.style.display = "block"; // báº­t khi báº¯n
  $fx.width=innerWidth;$fx.height=innerHeight;
  for(let i=0;i<count;i++){
    confettiParticles.push({
      x:x + (Math.random()*80-40),
      y:y + (Math.random()*20-10),
      vx:(Math.random()*4-2),
      vy:(-Math.random()*6-3),
      g:0.12 + Math.random()*0.08,
      s:6 + Math.random()*6,
      a:1,
      r:Math.random()*Math.PI,
      rc: Math.random()*255|0,
      gc: Math.random()*255|0,
      bc: Math.random()*255|0
    });
  }
  if(!animatingConfetti) animateConfetti();
}
let animatingConfetti=false;
function animateConfetti(){
  const $fx = document.getElementById("fx");
  animatingConfetti=true;
  fx.clearRect(0,0,$fx.width,$fx.height);
  confettiParticles = confettiParticles.filter(p => p.a>0 && p.y < innerHeight+40);
  confettiParticles.forEach(p=>{
    p.vy += p.g; p.x += p.vx; p.y += p.vy; p.r += 0.1; p.a *= 0.985;
    fx.save(); fx.translate(p.x,p.y); fx.rotate(p.r);
    fx.globalAlpha = Math.max(0,p.a);
    fx.fillStyle=`rgb(${p.rc},${p.gc},${p.bc})`;
    fx.fillRect(-p.s/2,-p.s/2,p.s,p.s*0.6);
    fx.restore();
  });
  if(confettiParticles.length){
    requestAnimationFrame(animateConfetti);
  }else{
    animatingConfetti=false;
    fx.clearRect(0,0,$fx.width,$fx.height);
    $fx.style.display = "none"; // áº©n khi xong
  }
}

/* ===== Chá»n & Quay ===== */
function chooseTargetIndex(){
  if(!items.length) return -1;
  if(spins===0){
    const key=norm(FORCED_NAME);
    const idx=items.findIndex(e=>norm(e.name).includes(key));
    if(idx!==-1) return idx; // Ã©p láº§n 1
  }
  return Math.floor(Math.random()*items.length);
}
let _lastTickIndex=-1;
const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

function spin(){
  if(!items.length || isSpinning || overlayActive) return;

  const n=items.length;
  const baseSeg=(2*Math.PI)/n, gap=Math.min(GAP_CAP, baseSeg*GAP_RATIO), seg=baseSeg-gap;
  const idx=chooseTargetIndex(); if(idx<0) return;

  const targetCenter=idx*baseSeg + gap/2 + seg/2;
  const extraTurns=6 + Math.random()*3;
  const targetRot = extraTurns*2*Math.PI + (2*Math.PI - targetCenter);

  isSpinning=true; $spinBtn.disabled=true;

  const duration = rand(BASE_MS_MIN, BASE_MS_MAX) + rand(EXTRA_MS_MIN, EXTRA_MS_MAX);
  animateSpin(rotation, rotation+targetRot, duration, baseSeg, ()=>{
    rotation=(2*Math.PI - targetCenter)%(2*Math.PI);
    const win=items[idx];
    spins++; drawWheel(); updateState(); playVictory();

    // log
    $resultBox.style.display=""; const div=document.createElement("div");
    div.className="result-item";
    div.innerHTML=`<span class="result-name">Láº§n ${spins}: ${win.name}</span><span class="result-info">${win.info||""}</span>`;
    $results.appendChild(div);

    // overlay + confetti
    $ovName.textContent=win.name; $ovInfo.textContent=win.info||"";
    $overlay.style.display="grid"; overlayActive=true;
    burstConfetti(innerWidth/2, innerHeight*0.18);

    // loáº¡i trÃ¹ng
    items.splice(idx,1);

    isSpinning=false;
  });
}

function animateSpin(from,to,duration,baseSeg,done){
  const start=performance.now(); _lastTickIndex=-1;
  function frame(now){
    const t=Math.min(1,(now-start)/duration);
    const eased=1 - Math.pow(1 - t, 3);
    rotation=from + (to-from)*eased;

    const pointer=(2*Math.PI - (rotation%(2*Math.PI)))%(2*Math.PI);
    const currentIndex=Math.floor(pointer/baseSeg);
    if(currentIndex!==_lastTickIndex){ playTick(); _lastTickIndex=currentIndex; }

    drawWheel();
    if(t<1) requestAnimationFrame(frame); else done();
  }
  requestAnimationFrame(frame);
}

/* NÃºt Quay: Ä‘áº£m báº£o audio má»Ÿ trÆ°á»›c khi spin */
document.getElementById("spinBtn").addEventListener("click", async ()=>{
  await ensureAudio();
  spin();
});

document.getElementById("ovContinue").addEventListener("click", ()=>{
  $overlay.style.display="none";
  overlayActive=false;
  $spinBtn.disabled = items.length===0;
  updateState();
});

/* ===== State ===== */
function updateState(){
  const remain = items.length;
  $stateInfo.textContent = remain>=0
    ? `CÃ²n láº¡i: ${remain}. ${remain? "Chuáº©n bá»‹ quay láº§n " + (spins + 1) + "." : "ÄÃ£ quay háº¿t danh sÃ¡ch."}`
    : "ChÆ°a cÃ³ dá»¯ liá»‡u.";
}

/* init */
function fitFX(){ const c=document.getElementById("fx"); c.width=innerWidth; c.height=innerHeight; }
addEventListener('resize', fitFX); fitFX();
drawWheel(); updateState();
</script>
</body>
</html>
